<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DriveSafe Research Demo</title>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      10%, 30%, 50%, 70%, 90% { transform: translateX(-10px); }
      20%, 40%, 60%, 80% { transform: translateX(10px); }
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    @keyframes gradient {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }
    @keyframes floatUp {
      from { 
        opacity: 1;
        transform: translateY(0) scale(1);
      }
      to { 
        opacity: 0;
        transform: translateY(-100px) scale(1.5);
      }
    }
    @keyframes pulse-glow {
      0%, 100% { 
        box-shadow: 0 0 20px rgba(34, 197, 94, 0.5);
        transform: scale(1);
      }
      50% { 
        box-shadow: 0 0 40px rgba(34, 197, 94, 0.8);
        transform: scale(1.05);
      }
    }
    @keyframes jump {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }
    @keyframes unlock {
      0% { transform: scale(0) rotate(-180deg); opacity: 0; }
      60% { transform: scale(1.2) rotate(10deg); opacity: 1; }
      100% { transform: scale(1) rotate(0deg); opacity: 1; }
    }
    @keyframes negativeHit {
      0% { transform: scale(1); filter: brightness(1); }
      50% { transform: scale(0.95); filter: brightness(0.5); }
      100% { transform: scale(1); filter: brightness(1); }
    }
    @keyframes slideUp {
      from { transform: translateY(100%); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    @keyframes confetti {
      0% { transform: translateY(0) rotate(0deg); opacity: 1; }
      100% { transform: translateY(-200px) rotate(720deg); opacity: 0; }
    }
    @keyframes rankUp {
      0% { transform: scale(1); }
      50% { transform: scale(1.3); filter: brightness(1.5); }
      100% { transform: scale(1); }
    }
    .animate-slideUp {
      animation: slideUp 0.3s ease-out;
    }
    .animate-confetti {
      animation: confetti 1s ease-out forwards;
    }
    .animate-rankUp {
      animation: rankUp 0.5s ease-out;
    }
    .animate-shake {
      animation: shake 0.5s ease-in-out;
    }
    .animate-fadeIn {
      animation: fadeIn 0.3s ease-in;
    }
    .animate-floatUp {
      animation: floatUp 1s ease-out forwards;
    }
    .animate-pulse-glow {
      animation: pulse-glow 2s ease-in-out infinite;
    }
    .animate-jump {
      animation: jump 0.3s ease-in-out;
    }
    .animate-unlock {
      animation: unlock 0.5s ease-out forwards;
    }
    .animate-negativeHit {
      animation: negativeHit 0.3s ease-in-out;
    }
    .gradient-bg {
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);
      background-size: 200% 200%;
      animation: gradient 15s ease infinite;
    }
    .glass-effect {
      background: rgba(30, 41, 59, 0.7);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .card-glow {
      box-shadow: 0 4px 20px rgba(34, 197, 94, 0.2), 0 0 0 1px rgba(34, 197, 94, 0.1);
    }
    /* Light theme styles */
    .light-theme {
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 50%, #cbd5e1 100%) !important;
    }
    .light-theme .glass-effect {
      background: rgba(255, 255, 255, 0.8) !important;
      border: 1px solid rgba(0, 0, 0, 0.1) !important;
    }
    .light-theme .text-slate-100,
    .light-theme .text-slate-200 {
      color: #1e293b !important;
    }
    .light-theme .text-slate-300,
    .light-theme .text-slate-400 {
      color: #475569 !important;
    }
    .light-theme .bg-slate-700,
    .light-theme .bg-slate-700\/50 {
      background: rgba(203, 213, 225, 0.5) !important;
    }
    .light-theme .border-slate-700\/50 {
      border-color: rgba(148, 163, 184, 0.3) !important;
    }
    .light-theme .bg-slate-900 {
      background: #f1f5f9 !important;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // Text-to-Speech for voice alerts
    const speakAlert = (message) => {
      if ('speechSynthesis' in window) {
        const utterance = new SpeechSynthesisUtterance(message);
        utterance.rate = 1.0;
        utterance.pitch = 1.0;
        utterance.volume = 1.0;
        utterance.lang = 'en-US';
        window.speechSynthesis.speak(utterance);
      }
    };

    const alertMessages = [
      "Be careful! Eyes on the road!",
      "Stay focused! Put the phone down!",
      "Warning! Keep your eyes on the road!",
      "Danger! Don't use your phone while driving!",
      "Stop! Your safety comes first!"
    ];

    const getRandomAlertMessage = () => {
      return alertMessages[Math.floor(Math.random() * alertMessages.length)];
    };

    // Sound effects
    const playDingSound = () => {
      const audioContext = new (window.AudioContext || window.webkitAudioContext)();
      const oscillator = audioContext.createOscillator();
      const gainNode = audioContext.createGain();
      
      oscillator.connect(gainNode);
      gainNode.connect(audioContext.destination);
      
      oscillator.frequency.setValueAtTime(523.25, audioContext.currentTime);
      oscillator.frequency.setValueAtTime(659.25, audioContext.currentTime + 0.1);
      oscillator.type = 'sine';
      
      gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
      gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
      
      oscillator.start(audioContext.currentTime);
      oscillator.stop(audioContext.currentTime + 0.3);
    };

    const playBuzzSound = () => {
      const audioContext = new (window.AudioContext || window.webkitAudioContext)();
      const oscillator = audioContext.createOscillator();
      const gainNode = audioContext.createGain();
      
      oscillator.connect(gainNode);
      gainNode.connect(audioContext.destination);
      
      oscillator.frequency.value = 150;
      oscillator.type = 'sawtooth';
      
      gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
      gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.4);
      
      oscillator.start(audioContext.currentTime);
      oscillator.stop(audioContext.currentTime + 0.4);
    };

    function ControlToggle({ viewMode, setViewMode, alertMode, setAlertMode }) {
      return (
        <div className="w-full max-w-md mb-6 space-y-4">
          <div>
            <label className="block text-slate-200 text-sm font-bold mb-3 text-center">
              Research Mode
            </label>
            <select
              value={viewMode}
              onChange={(e) => setViewMode(e.target.value)}
              className="w-full glass-effect text-slate-100 border-2 border-slate-600 rounded-xl px-4 py-3 font-semibold focus:outline-none focus:ring-2 focus:ring-green-400 focus:border-green-400 transition-all shadow-lg hover:border-green-500"
            >
              <option value="control">Control: Monitoring Active Only</option>
              <option value="nudge">Nudge Only: Status + Simulation Button</option>
              <option value="full">Full Gamification: Complete UI</option>
            </select>
          </div>
          <div>
            <label className="block text-slate-200 text-sm font-bold mb-3 text-center">
              🔔 Alert Type
            </label>
            <div className="flex gap-2">
              <button
                onClick={() => setAlertMode('vibration')}
                className={`flex-1 py-3 px-4 rounded-xl font-bold transition-all flex items-center justify-center gap-2 ${
                  alertMode === 'vibration'
                    ? 'bg-gradient-to-r from-green-500 to-emerald-500 text-white shadow-lg'
                    : 'glass-effect text-slate-400 border-2 border-slate-600 hover:border-green-500'
                }`}
              >
                📳 Vibration
              </button>
              <button
                onClick={() => setAlertMode('sound')}
                className={`flex-1 py-3 px-4 rounded-xl font-bold transition-all flex items-center justify-center gap-2 ${
                  alertMode === 'sound'
                    ? 'bg-gradient-to-r from-green-500 to-emerald-500 text-white shadow-lg'
                    : 'glass-effect text-slate-400 border-2 border-slate-600 hover:border-green-500'
                }`}
              >
                🔊 Voice Alert
              </button>
            </div>
            <p className="text-slate-400 text-xs text-center mt-2">
              {alertMode === 'sound' ? '🗣️ Voice will say "Be careful!" when you touch the phone' : '📳 Phone will vibrate and buzz'}
            </p>
          </div>
        </div>
      );
    }

    function PhoneFrame({ children, showAlert, onScreenClick, isDriving }) {
      return (
        <div className={`relative bg-gradient-to-br from-slate-800 via-slate-700 to-slate-800 rounded-[2.5rem] p-2 shadow-2xl transition-transform duration-300 ${showAlert ? 'animate-shake' : ''}`} style={{ boxShadow: '0 20px 60px rgba(0, 0, 0, 0.5), 0 0 0 2px rgba(34, 197, 94, 0.1)' }}>
          <div className="absolute top-0 left-1/2 transform -translate-x-1/2 w-32 h-6 bg-gradient-to-b from-slate-900 to-slate-800 rounded-b-2xl z-10"></div>
          <div 
            className={`bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 rounded-[2rem] overflow-hidden relative ${isDriving ? 'cursor-pointer' : ''}`}
            style={{ width: '375px', height: '812px' }}
            onClick={onScreenClick}
          >
            {children}
            {isDriving && (
              <div className="absolute top-3 right-3 bg-gradient-to-r from-green-500 to-emerald-500 text-white text-xs px-3 py-1.5 rounded-full font-bold z-20 animate-pulse shadow-lg" style={{ boxShadow: '0 0 20px rgba(34, 197, 94, 0.5)' }}>
                🚗 DRIVING - Click Screen
              </div>
            )}
          </div>
        </div>
      );
    }

    function ControlView() {
      return (
        <div className="h-full bg-slate-900 flex items-center justify-center">
          <div className="text-center px-8">
            <div className="inline-flex items-center justify-center w-20 h-20 rounded-full bg-green-500/20 mb-4">
              <div className="w-12 h-12 rounded-full bg-green-500 animate-pulse"></div>
            </div>
            <h2 className="text-2xl font-bold text-slate-200 mb-2">Monitoring Active</h2>
            <p className="text-slate-400 text-sm">DriveSafe is tracking your driving behavior</p>
          </div>
        </div>
      );
    }

    function NudgeOnlyView({ onStartDriving, isDriving, onStopDriving }) {
      return (
        <div className="h-full bg-slate-900 flex flex-col items-center justify-center px-6">
          <div className="text-center mb-8">
            <div className="inline-flex items-center justify-center w-20 h-20 rounded-full bg-green-500/20 mb-4">
              <div className="w-12 h-12 rounded-full bg-green-500 animate-pulse"></div>
            </div>
            <h2 className="text-2xl font-bold text-slate-200 mb-2">Monitoring Active</h2>
            <p className="text-slate-400 text-sm">DriveSafe is tracking your driving behavior</p>
          </div>
          <StartDrivingButton 
            onStartDriving={onStartDriving} 
            isDriving={isDriving}
            onStopDriving={onStopDriving}
          />
        </div>
      );
    }

    function Header({ currentPage, onNavigate, coins, theme, setTheme }) {
      return (
        <div className="glass-effect border-b border-slate-700/50">
          <div className="flex items-center justify-between px-6 py-5">
            <h1 className="text-3xl font-extrabold bg-gradient-to-r from-green-400 to-emerald-400 bg-clip-text text-transparent">
              DriveSafe
            </h1>
            <div className="flex items-center gap-3">
              <button
                onClick={() => setTheme(theme === 'dark' ? 'light' : 'dark')}
                className="w-9 h-9 rounded-full glass-effect flex items-center justify-center text-lg border border-slate-600/50 hover:border-green-500/50 transition-all"
                title={theme === 'dark' ? 'Switch to light mode' : 'Switch to dark mode'}
              >
                {theme === 'dark' ? '☀️' : '🌙'}
              </button>
              <div className="flex items-center gap-2 glass-effect px-3 py-1.5 rounded-full border border-yellow-500/30">
                <span className="text-yellow-400 text-lg">🪙</span>
                <span className="text-yellow-400 font-extrabold">{coins}</span>
              </div>
            </div>
          </div>
          <div className="flex gap-1 px-4 pb-3">
            <button
              onClick={() => onNavigate('dashboard')}
              className={`flex-1 py-2 px-2 rounded-lg font-bold text-sm transition-all ${
                currentPage === 'dashboard'
                  ? 'bg-gradient-to-r from-green-500 to-emerald-500 text-white shadow-lg'
                  : 'bg-slate-700/50 text-slate-400 hover:text-slate-200'
              }`}
            >
              📊 Home
            </button>
            <button
              onClick={() => onNavigate('history')}
              className={`flex-1 py-2 px-2 rounded-lg font-bold text-sm transition-all ${
                currentPage === 'history'
                  ? 'bg-gradient-to-r from-green-500 to-emerald-500 text-white shadow-lg'
                  : 'bg-slate-700/50 text-slate-400 hover:text-slate-200'
              }`}
            >
              🕐 History
            </button>
            <button
              onClick={() => onNavigate('social')}
              className={`flex-1 py-2 px-2 rounded-lg font-bold text-sm transition-all ${
                currentPage === 'social'
                  ? 'bg-gradient-to-r from-green-500 to-emerald-500 text-white shadow-lg'
                  : 'bg-slate-700/50 text-slate-400 hover:text-slate-200'
              }`}
            >
              👥 Social
            </button>
            <button
              onClick={() => onNavigate('shop')}
              className={`flex-1 py-2 px-2 rounded-lg font-bold text-sm transition-all ${
                currentPage === 'shop'
                  ? 'bg-gradient-to-r from-green-500 to-emerald-500 text-white shadow-lg'
                  : 'bg-slate-700/50 text-slate-400 hover:text-slate-200'
              }`}
            >
              🎨 Shop
            </button>
          </div>
        </div>
      );
    }

    function SafetyScoreCard({ score, isDriving, floatingPoints }) {
      const maxScore = 100;
      const percentage = (score / maxScore) * 100;
      const circumference = 2 * Math.PI * 70;
      const offset = circumference - (percentage / 100) * circumference;

      return (
        <div className="glass-effect rounded-3xl p-6 flex flex-col items-center card-glow relative">
          <h2 className="text-lg font-bold text-slate-200 mb-5">
            {isDriving ? '🎮 Live Score' : 'Weekly Safety Score'}
          </h2>
          <div className="relative w-44 h-44">
            <svg className="transform -rotate-90" width="176" height="176">
              <circle
                cx="88"
                cy="88"
                r="75"
                stroke="currentColor"
                strokeWidth="10"
                fill="none"
                className="text-slate-700/50"
              />
              <circle
                cx="88"
                cy="88"
                r="75"
                stroke="url(#gradient)"
                strokeWidth="10"
                fill="none"
                strokeDasharray={circumference}
                strokeDashoffset={offset}
                strokeLinecap="round"
                className="transition-all duration-500"
                style={{ filter: 'drop-shadow(0 0 8px rgba(34, 197, 94, 0.5))' }}
              />
              <defs>
                <linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                  <stop offset="0%" stopColor="#22c55e" />
                  <stop offset="100%" stopColor="#10b981" />
                </linearGradient>
              </defs>
            </svg>
            <div className="absolute inset-0 flex flex-col items-center justify-center">
              <span className="text-5xl font-extrabold bg-gradient-to-r from-green-400 to-emerald-400 bg-clip-text text-transparent">{score}</span>
              <span className="text-xl text-slate-400 font-semibold">/ {maxScore}</span>
            </div>
          </div>
          {/* Floating points animations */}
          {floatingPoints.map((point, index) => (
            <div
              key={point.id}
              className="absolute animate-floatUp text-2xl font-bold text-green-400"
              style={{
                top: '50%',
                left: '50%',
                transform: 'translate(-50%, -50%)',
                pointerEvents: 'none'
              }}
            >
              +{point.value}
            </div>
          ))}
        </div>
      );
    }

    function StatsRow({ streak, isDriving }) {
      const glowIntensity = Math.min(streak / 7, 1); // Max glow at 7 days
      
      return (
        <div className="grid grid-cols-2 gap-4">
          <div className="glass-effect rounded-2xl p-5 card-glow border border-slate-700/50">
            <div className="text-slate-400 text-xs mb-2 font-semibold uppercase tracking-wide">Weekly Hours Driven</div>
            <div className="text-3xl font-extrabold text-slate-100">12.5</div>
          </div>
          <div 
            className={`glass-effect rounded-2xl p-5 border transition-all duration-300 ${
              isDriving && streak > 0 ? 'animate-pulse-glow' : ''
            }`}
            style={{
              borderColor: `rgba(34, 197, 94, ${0.3 + glowIntensity * 0.7})`,
              boxShadow: `0 0 ${20 + glowIntensity * 30}px rgba(34, 197, 94, ${0.2 + glowIntensity * 0.5})`
            }}
          >
            <div className="text-slate-400 text-xs mb-2 font-semibold uppercase tracking-wide flex items-center gap-1">
              🔥 Streak
            </div>
            <div 
              className="text-3xl font-extrabold bg-gradient-to-r from-green-400 to-emerald-400 bg-clip-text text-transparent"
              style={{
                filter: `brightness(${1 + glowIntensity * 0.5})`
              }}
            >
              {streak} {streak === 1 ? 'min' : 'mins'}
            </div>
          </div>
        </div>
      );
    }

    function GamificationSection({ unlockedBadges }) {
      const badges = [
        { name: 'No-Text Streak', icon: '📱', id: 'notext' },
        { name: 'Safe Commuter', icon: '🚗', id: 'commuter' },
        { name: 'Focus Master', icon: '🎯', id: 'focus' }
      ];

      return (
        <div className="glass-effect rounded-3xl p-6 card-glow border border-slate-700/50">
          <h2 className="text-lg font-extrabold text-slate-200 mb-5 flex items-center gap-2">
            <span>🏆</span>
            <span>Badges</span>
          </h2>
          <div className="grid grid-cols-3 gap-3" style={{ alignItems: 'stretch' }}>
            {badges.map((badge, index) => {
              const earned = unlockedBadges.includes(badge.id);
              const justUnlocked = unlockedBadges[unlockedBadges.length - 1] === badge.id;
              
              return (
                <div
                  key={index}
                  className={`rounded-2xl transition-all relative ${
                    earned
                      ? 'bg-gradient-to-br from-yellow-500/20 to-orange-500/20 border-2 border-yellow-400/70 shadow-lg' 
                      : 'bg-slate-700/30 border-2 border-slate-600/50'
                  } ${justUnlocked ? 'animate-unlock' : ''}`}
                  style={{
                    height: '140px',
                    padding: '16px',
                    ...(earned ? { boxShadow: '0 4px 20px rgba(234, 179, 8, 0.4), 0 0 30px rgba(234, 179, 8, 0.2)' } : {})
                  }}
                >
                  <div 
                    className={`text-5xl transition-all ${earned ? 'scale-110' : 'grayscale opacity-40'}`}
                    style={{ 
                      position: 'absolute',
                      top: '16px',
                      left: '50%',
                      transform: `translateX(-50%) ${earned ? 'scale(1.1)' : 'scale(1)'}`,
                      width: '100%',
                      height: '64px',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center',
                      margin: 0,
                      filter: earned ? 'drop-shadow(0 0 10px rgba(234, 179, 8, 0.6))' : 'none'
                    }}
                  >
                    {badge.icon}
                  </div>
                  <div 
                    className={`text-xs font-bold text-center ${earned ? 'text-yellow-300' : 'text-slate-500'}`}
                    style={{ 
                      position: 'absolute',
                      bottom: '16px',
                      left: '50%',
                      transform: 'translateX(-50%)',
                      width: '100%',
                      height: '36px',
                      display: 'flex',
                      flexDirection: 'column',
                      justifyContent: 'center',
                      alignItems: 'center',
                      lineHeight: '18px',
                      margin: 0
                    }}
                  >
                    <div style={{ height: '18px', lineHeight: '18px' }}>{badge.name.split(' ')[0]}</div>
                    <div style={{ height: '18px', lineHeight: '18px' }}>{badge.name.split(' ')[1]}</div>
                  </div>
                </div>
              );
            })}
          </div>
        </div>
      );
    }

    function LeaderboardPreview({ currentScore, animatingRanks, userAvatar, currentRank }) {
      const [topUsers, setTopUsers] = useState([
        { rank: 1, name: 'Alex M.', score: 98, avatar: '😎' },
        { rank: 2, name: 'Sarah K.', score: 96, avatar: '🌟' },
        { rank: 3, name: 'Mike T.', score: 95, avatar: '🚀' }
      ]);
      
      // Insert current user if they're in top 3
      const userInTop3 = currentRank <= 3;
      const displayUsers = userInTop3 
        ? topUsers.map(u => u.rank === currentRank ? { ...u, name: 'You', avatar: userAvatar, isUser: true } : u)
        : topUsers;

      return (
        <div className="glass-effect rounded-3xl p-6 card-glow border border-slate-700/50">
          <div className="flex items-center justify-between mb-5">
            <h2 className="text-lg font-extrabold text-slate-200">🏅 Leaderboard</h2>
            <div className="text-sm font-extrabold bg-gradient-to-r from-green-400 to-emerald-400 bg-clip-text text-transparent px-3 py-1 rounded-full glass-effect border border-green-500/30">
              Rank #{currentScore >= 98 ? '1' : currentScore >= 96 ? '2' : currentScore >= 95 ? '3' : '5'}
            </div>
          </div>
          <div className="space-y-2">
            {displayUsers.map((user) => {
              const isJumping = animatingRanks.includes(user.rank);
              
              return (
                <div 
                  key={user.rank} 
                  className={`flex items-center justify-between glass-effect rounded-xl p-3 border transition-all ${
                    user.isUser ? 'border-green-500/50 bg-green-500/10' : 'border-slate-700/50'
                  } hover:border-green-500/30 ${
                    isJumping ? 'animate-jump' : ''
                  }`}
                >
                  <div className="flex items-center gap-3">
                    <div className={`w-9 h-9 rounded-full flex items-center justify-center text-xs font-extrabold ${
                      user.rank === 1 ? 'bg-gradient-to-br from-yellow-400 to-orange-400 text-slate-900' :
                      user.rank === 2 ? 'bg-gradient-to-br from-slate-400 to-slate-500 text-white' :
                      'bg-gradient-to-br from-amber-600 to-amber-700 text-white'
                    } shadow-lg`}>
                      #{user.rank}
                    </div>
                    <span className="text-3xl">{user.avatar}</span>
                    <span className={`font-bold ${
                      user.isUser ? 'text-green-300' : 'text-slate-200'
                    }`}>{user.name}</span>
                  </div>
                  <span className="text-green-400 font-extrabold text-lg">{user.score}</span>
                </div>
              );
            })}
          </div>
        </div>
      );
    }

    function AvatarShop({ coins, ownedSkins, selectedAvatar, onPurchase, onSelect, currentRank }) {
      const skins = [
        { id: 'default', emoji: '👤', name: 'Default', price: 0, requiredRank: 10 },
        { id: 'cool', emoji: '😎', name: 'Cool Guy', price: 100, requiredRank: 5 },
        { id: 'star', emoji: '⭐', name: 'Star', price: 150, requiredRank: 4 },
        { id: 'fire', emoji: '🔥', name: 'Fire', price: 200, requiredRank: 3 },
        { id: 'crown', emoji: '👑', name: 'King', price: 300, requiredRank: 2 },
        { id: 'trophy', emoji: '🏆', name: 'Champion', price: 500, requiredRank: 1 },
        { id: 'rocket', emoji: '🚀', name: 'Rocket', price: 250, requiredRank: 3 },
        { id: 'gem', emoji: '💎', name: 'Diamond', price: 400, requiredRank: 1 },
      ];

      return (
        <div className="glass-effect rounded-3xl p-6 card-glow border border-slate-700/50">
          <h2 className="text-lg font-extrabold text-slate-200 flex items-center gap-2 mb-5">
            <span>🎨</span>
            <span>Avatar Skins</span>
          </h2>
          <div className="grid grid-cols-4 gap-3">
            {skins.map((skin) => {
              const owned = ownedSkins.includes(skin.id);
              const selected = selectedAvatar === skin.id;
              const locked = currentRank > skin.requiredRank;
              const canAfford = coins >= skin.price;
              
              return (
                <div
                  key={skin.id}
                  className={`relative rounded-xl p-3 transition-all cursor-pointer ${
                    selected 
                      ? 'bg-gradient-to-br from-green-500/30 to-emerald-500/30 border-2 border-green-400 shadow-lg' 
                      : owned
                      ? 'bg-slate-700/30 border-2 border-slate-600 hover:border-green-500/50'
                      : locked
                      ? 'bg-slate-800/50 border-2 border-red-500/30 cursor-not-allowed'
                      : 'bg-slate-700/30 border-2 border-yellow-500/30 hover:border-yellow-500'
                  }`}
                  onClick={() => {
                    if (owned && !selected) {
                      onSelect(skin.id);
                      playDingSound();
                    } else if (!owned && !locked && canAfford) {
                      onPurchase(skin.id, skin.price);
                      playDingSound();
                    } else if (!canAfford && !locked) {
                      playBuzzSound();
                    }
                  }}
                  style={{
                    boxShadow: selected ? '0 0 20px rgba(34, 197, 94, 0.4)' : 'none'
                  }}
                >
                  <div className="text-center">
                    <div className={`text-3xl mb-1 transition-all ${
                      locked ? 'grayscale opacity-30' : owned ? '' : 'opacity-70'
                    }`}>
                      {locked ? '🔒' : skin.emoji}
                    </div>
                    <div className={`text-xs font-bold ${
                      selected ? 'text-green-300' : owned ? 'text-slate-300' : locked ? 'text-red-400' : 'text-yellow-300'
                    }`}>
                      {locked ? `Rank ${skin.requiredRank}` : owned ? (selected ? '✓ Active' : 'Owned') : `🪙${skin.price}`}
                    </div>
                  </div>
                  {selected && (
                    <div className="absolute -top-1 -right-1 w-5 h-5 bg-green-500 rounded-full flex items-center justify-center">
                      <span className="text-white text-xs">✓</span>
                    </div>
                  )}
                </div>
              );
            })}
          </div>
          <p className="text-slate-400 text-xs mt-4 text-center">
            💡 Earn coins by driving safely. Higher ranks unlock exclusive skins!
          </p>
        </div>
      );
    }

    function TripHistoryPage({ tripHistory, totalStats }) {
      const formatDate = (timestamp) => {
        const date = new Date(timestamp);
        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
      };
      
      const formatDuration = (seconds) => {
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        return `${mins}:${String(secs).padStart(2, '0')}`;
      };

      return (
        <div className="space-y-4">
          {/* Summary Stats */}
          <div className="glass-effect rounded-3xl p-5 card-glow border border-slate-700/50">
            <h2 className="text-lg font-extrabold text-slate-200 mb-4 flex items-center gap-2">
              <span>📈</span> Your Stats
            </h2>
            <div className="grid grid-cols-2 gap-3">
              <div className="glass-effect rounded-xl p-3 text-center border border-slate-700/50">
                <div className="text-2xl font-extrabold text-green-400">{totalStats.totalTrips}</div>
                <div className="text-xs text-slate-400 font-semibold">Total Trips</div>
              </div>
              <div className="glass-effect rounded-xl p-3 text-center border border-slate-700/50">
                <div className="text-2xl font-extrabold text-blue-400">{formatDuration(totalStats.totalDuration)}</div>
                <div className="text-xs text-slate-400 font-semibold">Total Time</div>
              </div>
              <div className="glass-effect rounded-xl p-3 text-center border border-slate-700/50">
                <div className="text-2xl font-extrabold text-yellow-400">{totalStats.bestScore}</div>
                <div className="text-xs text-slate-400 font-semibold">Best Score</div>
              </div>
              <div className="glass-effect rounded-xl p-3 text-center border border-slate-700/50">
                <div className="text-2xl font-extrabold text-purple-400">{totalStats.totalCoins}</div>
                <div className="text-xs text-slate-400 font-semibold">Coins Earned</div>
              </div>
            </div>
          </div>

          {/* Trip List */}
          <div className="glass-effect rounded-3xl p-5 card-glow border border-slate-700/50">
            <h2 className="text-lg font-extrabold text-slate-200 mb-4 flex items-center gap-2">
              <span>🕐</span> Recent Trips
            </h2>
            {tripHistory.length === 0 ? (
              <div className="text-center py-8">
                <div className="text-4xl mb-3">🚗</div>
                <p className="text-slate-400">No trips yet. Start driving to log your first trip!</p>
              </div>
            ) : (
              <div className="space-y-2 max-h-64 overflow-y-auto">
                {tripHistory.slice().reverse().map((trip, index) => (
                  <div key={trip.id} className="glass-effect rounded-xl p-3 border border-slate-700/50 hover:border-green-500/30 transition-all">
                    <div className="flex items-center justify-between mb-2">
                      <span className="text-slate-300 text-sm font-semibold">{formatDate(trip.timestamp)}</span>
                      <span className={`text-sm font-bold px-2 py-0.5 rounded-full ${
                        trip.score >= 95 ? 'bg-green-500/20 text-green-400' :
                        trip.score >= 80 ? 'bg-yellow-500/20 text-yellow-400' :
                        'bg-red-500/20 text-red-400'
                      }`}>
                        Score: {trip.score}
                      </span>
                    </div>
                    <div className="flex items-center gap-4 text-xs text-slate-400">
                      <span>⏱️ {formatDuration(trip.duration)}</span>
                      <span>⚠️ {trip.nudges} nudges</span>
                      <span>🪙 +{trip.coinsEarned}</span>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>
        </div>
      );
    }

    function SocialPage({ score, currentRank, onShare, friends, onChallenge, challenges, onAcceptChallenge, getAvatarEmoji, selectedAvatar }) {
      const [showShareModal, setShowShareModal] = useState(false);
      const [showChallengeModal, setShowChallengeModal] = useState(false);
      const [selectedFriend, setSelectedFriend] = useState(null);
      
      return (
        <div className="space-y-4">
          {/* Share Score Card */}
          <div className="glass-effect rounded-3xl p-5 card-glow border border-slate-700/50">
            <h2 className="text-lg font-extrabold text-slate-200 mb-4 flex items-center gap-2">
              <span>📤</span> Share Your Score
            </h2>
            <div className="flex items-center justify-between glass-effect rounded-xl p-4 border border-green-500/30 mb-4">
              <div className="flex items-center gap-3">
                <div className="text-4xl">{getAvatarEmoji(selectedAvatar)}</div>
                <div>
                  <div className="text-slate-300 font-bold">Your Score</div>
                  <div className="text-3xl font-extrabold text-green-400">{score}</div>
                </div>
              </div>
              <div className="text-center">
                <div className="text-slate-400 text-xs">Rank</div>
                <div className="text-2xl font-extrabold text-yellow-400">#{currentRank}</div>
              </div>
            </div>
            <div className="grid grid-cols-4 gap-2">
              <button 
                onClick={() => onShare('twitter')}
                className="glass-effect rounded-xl p-2 text-center border border-slate-600 hover:border-slate-400 transition-all"
              >
                <div className="w-8 h-8 mx-auto mb-1 rounded-lg bg-black flex items-center justify-center">
                  <span className="text-white font-bold text-lg">𝕏</span>
                </div>
                <div className="text-[10px] text-slate-300 truncate">Twitter</div>
              </button>
              <button 
                onClick={() => onShare('facebook')}
                className="glass-effect rounded-xl p-2 text-center border border-blue-600/30 hover:border-blue-600 transition-all"
              >
                <div className="w-8 h-8 mx-auto mb-1 rounded-lg bg-blue-600 flex items-center justify-center">
                  <span className="text-white font-bold text-xl">f</span>
                </div>
                <div className="text-[10px] text-slate-300 truncate">Facebook</div>
              </button>
              <button 
                onClick={() => onShare('instagram')}
                className="glass-effect rounded-xl p-2 text-center border border-pink-500/30 hover:border-pink-500 transition-all"
              >
                <div className="w-8 h-8 mx-auto mb-1 rounded-lg flex items-center justify-center" style={{ background: 'linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%)' }}>
                  <span className="text-white text-lg">📷</span>
                </div>
                <div className="text-[10px] text-slate-300 truncate">Instagram</div>
              </button>
              <button 
                onClick={() => onShare('copy')}
                className="glass-effect rounded-xl p-2 text-center border border-slate-500/30 hover:border-slate-400 transition-all"
              >
                <div className="w-8 h-8 mx-auto mb-1 rounded-lg bg-slate-600 flex items-center justify-center">
                  <span className="text-white text-lg">📋</span>
                </div>
                <div className="text-[10px] text-slate-300 truncate">Copy</div>
              </button>
            </div>
          </div>

          {/* Active Challenges */}
          <div className="glass-effect rounded-3xl p-5 card-glow border border-slate-700/50">
            <h2 className="text-lg font-extrabold text-slate-200 mb-4 flex items-center gap-2">
              <span>⚔️</span> Active Challenges
            </h2>
            {challenges.length === 0 ? (
              <div className="text-center py-4">
                <div className="text-3xl mb-2">🎯</div>
                <p className="text-slate-400 text-sm">No active challenges. Challenge a friend below!</p>
              </div>
            ) : (
              <div className="space-y-2 max-h-32 overflow-y-auto">
                {challenges.map((challenge) => (
                  <div key={challenge.id} className="glass-effect rounded-xl p-3 border border-orange-500/30">
                    <div className="flex items-center justify-between">
                      <div className="flex items-center gap-2">
                        <span className="text-2xl">{challenge.avatar}</span>
                        <div>
                          <div className="text-slate-200 font-bold text-sm">{challenge.from}</div>
                          <div className="text-xs text-slate-400">Beat {challenge.targetScore} pts!</div>
                        </div>
                      </div>
                      {challenge.status === 'pending' ? (
                        <button 
                          onClick={() => onAcceptChallenge(challenge.id)}
                          className="bg-gradient-to-r from-orange-500 to-amber-500 text-white text-xs font-bold px-3 py-1.5 rounded-lg"
                        >
                          Accept
                        </button>
                      ) : (
                        <span className={`text-xs font-bold px-2 py-1 rounded-full ${
                          challenge.status === 'won' ? 'bg-green-500/20 text-green-400' :
                          challenge.status === 'lost' ? 'bg-red-500/20 text-red-400' :
                          'bg-blue-500/20 text-blue-400'
                        }`}>
                          {challenge.status === 'active' ? 'In Progress' : challenge.status.toUpperCase()}
                        </span>
                      )}
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>

          {/* Friends List - Challenge */}
          <div className="glass-effect rounded-3xl p-5 card-glow border border-slate-700/50">
            <h2 className="text-lg font-extrabold text-slate-200 mb-4 flex items-center gap-2">
              <span>👥</span> Challenge Friends
            </h2>
            <div className="space-y-2">
              {friends.map((friend) => (
                <div key={friend.id} className="glass-effect rounded-xl p-3 border border-slate-700/50 hover:border-green-500/30 transition-all">
                  <div className="flex items-center justify-between">
                    <div className="flex items-center gap-3">
                      <span className="text-2xl">{friend.avatar}</span>
                      <div>
                        <div className="text-slate-200 font-bold">{friend.name}</div>
                        <div className="text-xs text-slate-400">Score: {friend.score} • Rank #{friend.rank}</div>
                      </div>
                    </div>
                    <button 
                      onClick={() => onChallenge(friend)}
                      className="bg-gradient-to-r from-purple-500 to-pink-500 text-white text-xs font-bold px-3 py-1.5 rounded-lg hover:scale-105 transition-transform"
                    >
                      ⚔️ Challenge
                    </button>
                  </div>
                </div>
              ))}
            </div>
          </div>
        </div>
      );
    }

    function ImprovedLeaderboard({ currentScore, animatingRanks, userAvatar, currentRank, leaderboardFilter, setLeaderboardFilter, allUsers, friends }) {
      const [showRankAnimation, setShowRankAnimation] = useState(null);
      
      const filteredUsers = leaderboardFilter === 'friends' 
        ? allUsers.filter(u => u.isFriend || u.isUser)
        : allUsers;
      
      const displayUsers = filteredUsers.slice(0, 10);
      
      const getRankBadge = (rank) => {
        if (rank === 1) return { emoji: '🥇', bg: 'from-yellow-400 to-orange-400', text: 'text-slate-900' };
        if (rank === 2) return { emoji: '🥈', bg: 'from-slate-300 to-slate-400', text: 'text-slate-900' };
        if (rank === 3) return { emoji: '🥉', bg: 'from-amber-600 to-amber-700', text: 'text-white' };
        return { emoji: null, bg: 'from-slate-600 to-slate-700', text: 'text-white' };
      };

      return (
        <div className="glass-effect rounded-3xl p-5 card-glow border border-slate-700/50">
          <div className="flex items-center justify-between mb-4">
            <h2 className="text-lg font-extrabold text-slate-200 flex items-center gap-2">
              <span>🏅</span> Leaderboard
            </h2>
            <div className="flex gap-1">
              <button 
                onClick={() => setLeaderboardFilter('all')}
                className={`px-3 py-1 rounded-lg text-xs font-bold transition-all ${
                  leaderboardFilter === 'all' 
                    ? 'bg-green-500 text-white' 
                    : 'bg-slate-700 text-slate-400 hover:text-white'
                }`}
              >
                All
              </button>
              <button 
                onClick={() => setLeaderboardFilter('friends')}
                className={`px-3 py-1 rounded-lg text-xs font-bold transition-all ${
                  leaderboardFilter === 'friends' 
                    ? 'bg-green-500 text-white' 
                    : 'bg-slate-700 text-slate-400 hover:text-white'
                }`}
              >
                Friends
              </button>
            </div>
          </div>
          
          {/* Your Position Banner */}
          <div className="glass-effect rounded-xl p-3 mb-4 border-2 border-green-500/50 bg-green-500/10">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-3">
                <div className={`w-10 h-10 rounded-full flex items-center justify-center text-sm font-extrabold bg-gradient-to-br ${getRankBadge(currentRank).bg} ${getRankBadge(currentRank).text} shadow-lg`}>
                  {getRankBadge(currentRank).emoji || `#${currentRank}`}
                </div>
                <span className="text-3xl">{userAvatar}</span>
                <div>
                  <div className="text-green-300 font-bold">You</div>
                  <div className="text-xs text-slate-400">Keep driving safe to rank up!</div>
                </div>
              </div>
              <div className="text-right">
                <div className="text-2xl font-extrabold text-green-400">{currentScore}</div>
                <div className="text-xs text-slate-400">points</div>
              </div>
            </div>
          </div>

          {/* Leaderboard List */}
          <div className="space-y-2 max-h-48 overflow-y-auto">
            {displayUsers.map((user) => {
              const isJumping = animatingRanks.includes(user.rank);
              const badge = getRankBadge(user.rank);
              
              return (
                <div 
                  key={user.rank} 
                  className={`flex items-center justify-between glass-effect rounded-xl p-3 border transition-all ${
                    user.isUser ? 'border-green-500/50 bg-green-500/10' : 
                    user.isFriend ? 'border-purple-500/30' : 'border-slate-700/50'
                  } hover:border-green-500/30 ${
                    isJumping ? 'animate-jump' : ''
                  } ${showRankAnimation === user.rank ? 'animate-rankUp' : ''}`}
                >
                  <div className="flex items-center gap-3">
                    <div className={`w-9 h-9 rounded-full flex items-center justify-center text-xs font-extrabold bg-gradient-to-br ${badge.bg} ${badge.text} shadow-lg`}>
                      {badge.emoji || `#${user.rank}`}
                    </div>
                    <span className="text-2xl">{user.avatar}</span>
                    <div>
                      <span className={`font-bold ${
                        user.isUser ? 'text-green-300' : user.isFriend ? 'text-purple-300' : 'text-slate-200'
                      }`}>
                        {user.name}
                        {user.isFriend && !user.isUser && <span className="ml-1 text-xs">👥</span>}
                      </span>
                      {user.streak > 0 && (
                        <div className="text-xs text-orange-400">🔥 {user.streak} day streak</div>
                      )}
                    </div>
                  </div>
                  <div className="text-right">
                    <span className="text-green-400 font-extrabold text-lg">{user.score}</span>
                    {user.change && (
                      <div className={`text-xs font-bold ${user.change > 0 ? 'text-green-400' : 'text-red-400'}`}>
                        {user.change > 0 ? '↑' : '↓'} {Math.abs(user.change)}
                      </div>
                    )}
                  </div>
                </div>
              );
            })}
          </div>
        </div>
      );
    }

    function StartDrivingButton({ onStartDriving, isDriving, onStopDriving, tripDuration, setTripDuration }) {
      if (isDriving) {
        return (
          <button
            onClick={(e) => {
              e.stopPropagation(); // Prevent triggering screen click
              onStopDriving();
            }}
            className="w-full bg-gradient-to-r from-red-600 to-rose-600 hover:from-red-700 hover:to-rose-700 text-white font-extrabold py-5 px-6 rounded-2xl text-lg transition-all shadow-2xl active:scale-95 transform hover:scale-105"
            style={{ boxShadow: '0 10px 30px rgba(220, 38, 38, 0.4)' }}
          >
            🛑 STOP DRIVING
          </button>
        );
      }
      return (
        <div className="space-y-4">
          <div className="glass-effect rounded-2xl p-5 border border-slate-700/50">
            <label className="block text-slate-200 text-sm font-bold mb-3 text-center">
              🕐 Set Trip Duration
            </label>
            <input
              type="range"
              min="1"
              max="30"
              value={tripDuration}
              onChange={(e) => setTripDuration(Number(e.target.value))}
              className="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-green-500"
            />
            <div className="text-center mt-3">
              <span className="text-4xl font-bold bg-gradient-to-r from-green-400 to-emerald-400 bg-clip-text text-transparent">
                {tripDuration}
              </span>
              <span className="text-slate-300 text-lg ml-2">minutes</span>
            </div>
          </div>
          <button
            onClick={(e) => {
              e.stopPropagation(); // Prevent triggering screen click
              onStartDriving();
            }}
            className="w-full bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 text-white font-extrabold py-5 px-6 rounded-2xl text-lg transition-all shadow-2xl active:scale-95 transform hover:scale-105"
            style={{ boxShadow: '0 10px 30px rgba(34, 197, 94, 0.4)' }}
          >
            🚗 START DRIVING
          </button>
        </div>
      );
    }

    function DrivingSessionProgress({ progress, hasNudge }) {
      return (
        <div className="glass-effect rounded-3xl p-6 card-glow border border-slate-700/50">
          <h2 className="text-lg font-extrabold text-slate-200 mb-4 flex items-center gap-2">
            <span>🛣️</span>
            <span>Driving Session</span>
          </h2>
          <div className="relative w-full h-8 bg-slate-700/50 rounded-full overflow-hidden border-2 border-slate-600">
            <div 
              className={`absolute inset-y-0 left-0 transition-all duration-500 ${
                hasNudge 
                  ? 'bg-gradient-to-r from-red-500 to-rose-500 animate-negativeHit' 
                  : 'bg-gradient-to-r from-green-500 to-emerald-500'
              }`}
              style={{ 
                width: `${progress}%`,
                boxShadow: hasNudge 
                  ? '0 0 20px rgba(239, 68, 68, 0.6)' 
                  : '0 0 20px rgba(34, 197, 94, 0.6)'
              }}
            />
            <div className="absolute inset-0 flex items-center justify-center text-white font-bold text-sm">
              {Math.round(progress)}%
            </div>
          </div>
          <p className="text-slate-400 text-xs mt-2 text-center">
            {hasNudge ? '⚠️ Phone use detected!' : '✨ Keep your eyes on the road!'}
          </p>
        </div>
      );
    }

    function FullGamificationView({ onStartDriving, isDriving, onStopDriving, score, floatingPoints, streak, unlockedBadges, animatingRanks, sessionProgress, hasRecentNudge, tripDuration, setTripDuration, coins, ownedSkins, selectedAvatar, onPurchaseSkin, onSelectAvatar, getAvatarEmoji, currentRank, currentPage, onNavigate, tripHistory, totalStats, friends, challenges, onChallenge, onAcceptChallenge, onShare, leaderboardFilter, setLeaderboardFilter, allUsers, theme, setTheme }) {
      return (
        <div className={`h-full bg-slate-900 flex flex-col overflow-y-auto ${theme === 'light' ? 'light-theme' : ''}`}>
          <Header currentPage={currentPage} onNavigate={onNavigate} coins={coins} theme={theme} setTheme={setTheme} />
          <div className="flex-1 px-6 py-4 space-y-6">
            {currentPage === 'history' ? (
              // History Page
              <TripHistoryPage tripHistory={tripHistory} totalStats={totalStats} />
            ) : currentPage === 'social' ? (
              // Social Page
              <SocialPage 
                score={score}
                currentRank={currentRank}
                onShare={onShare}
                friends={friends}
                onChallenge={onChallenge}
                challenges={challenges}
                onAcceptChallenge={onAcceptChallenge}
                getAvatarEmoji={getAvatarEmoji}
                selectedAvatar={selectedAvatar}
              />
            ) : currentPage === 'shop' ? (
              // Shop Page
              <>
                <div className="text-center py-6">
                  <h2 className="text-3xl font-extrabold bg-gradient-to-r from-yellow-400 to-orange-400 bg-clip-text text-transparent mb-2">
                    Avatar Shop
                  </h2>
                  <p className="text-slate-400">Unlock exclusive skins by ranking up!</p>
                </div>
                <AvatarShop 
                  coins={coins}
                  ownedSkins={ownedSkins}
                  selectedAvatar={selectedAvatar}
                  onPurchase={onPurchaseSkin}
                  onSelect={onSelectAvatar}
                  currentRank={currentRank}
                />
                <div className="glass-effect rounded-2xl p-5 border border-slate-700/50">
                  <h3 className="text-lg font-bold text-slate-200 mb-3">Current Avatar</h3>
                  <div className="flex items-center justify-center gap-4">
                    <div className="text-6xl">{getAvatarEmoji(selectedAvatar)}</div>
                    <div>
                      <div className="text-slate-300 font-bold mb-1">Your Rank</div>
                      <div className="text-3xl font-extrabold bg-gradient-to-r from-green-400 to-emerald-400 bg-clip-text text-transparent">
                        #{currentRank}
                      </div>
                    </div>
                  </div>
                </div>
              </>
            ) : isDriving ? (
              // Driving Mode: Minimalist UI
              <>
                <div className="flex items-center justify-center h-32">
                  <div className="text-center">
                    <div className="text-6xl mb-2">🚗</div>
                    <h2 className="text-2xl font-bold text-slate-200">Driving Mode</h2>
                    <p className="text-slate-400 text-sm mt-1">Stay focused on the road</p>
                  </div>
                </div>
                <SafetyScoreCard score={score} isDriving={isDriving} floatingPoints={floatingPoints} />
                <StatsRow streak={streak} isDriving={isDriving} />
                <DrivingSessionProgress progress={sessionProgress} hasNudge={hasRecentNudge} />
                <StartDrivingButton 
                  onStartDriving={onStartDriving} 
                  isDriving={isDriving}
                  onStopDriving={onStopDriving}
                  tripDuration={tripDuration}
                  setTripDuration={setTripDuration}
                />
              </>
            ) : (
              // Dashboard Page
              <>
                <SafetyScoreCard score={score} isDriving={isDriving} floatingPoints={floatingPoints} />
                <StatsRow streak={streak} isDriving={isDriving} />
                <GamificationSection unlockedBadges={unlockedBadges} />
                <ImprovedLeaderboard 
                  currentScore={score} 
                  animatingRanks={animatingRanks} 
                  userAvatar={getAvatarEmoji(selectedAvatar)} 
                  currentRank={currentRank}
                  leaderboardFilter={leaderboardFilter}
                  setLeaderboardFilter={setLeaderboardFilter}
                  allUsers={allUsers}
                  friends={friends}
                />
                <StartDrivingButton 
                  onStartDriving={onStartDriving} 
                  isDriving={isDriving}
                  onStopDriving={onStopDriving}
                  tripDuration={tripDuration}
                  setTripDuration={setTripDuration}
                />
              </>
            )}
          </div>
        </div>
      );
    }

    function AlertOverlay() {
      return (
        <div className="fixed inset-0 bg-red-600/90 flex items-center justify-center z-50 animate-fadeIn">
          <div className="text-center px-8">
            <div className="text-6xl mb-4 animate-bounce">⚠️</div>
            <h2 className="text-4xl font-bold text-white mb-2">PHONE USE DETECTED!</h2>
            <p className="text-2xl text-white/90 font-semibold">Focus on the road.</p>
          </div>
        </div>
      );
    }

    function App() {
      const [viewMode, setViewMode] = useState('full');
      const [alertMode, setAlertMode] = useState('vibration'); // 'vibration' or 'sound'
      const [theme, setTheme] = useState('dark'); // 'dark' or 'light'
      const [showAlert, setShowAlert] = useState(false);
      const [isDriving, setIsDriving] = useState(false);
      const [phoneShake, setPhoneShake] = useState(false);
      const [startTime, setStartTime] = useState(null);
      const [tripDurationSeconds, setTripDurationSeconds] = useState(0);
      const [tripDuration, setTripDuration] = useState(5);
      const [score, setScore] = useState(92);
      const [coins, setCoins] = useState(250);
      const [ownedSkins, setOwnedSkins] = useState(['default']);
      const [selectedAvatar, setSelectedAvatar] = useState('default');
      const [floatingPoints, setFloatingPoints] = useState([]);
      const [streak, setStreak] = useState(0);
      const [unlockedBadges, setUnlockedBadges] = useState(['notext', 'commuter']);
      const [animatingRanks, setAnimatingRanks] = useState([]);
      const [sessionProgress, setSessionProgress] = useState(0);
      const [hasRecentNudge, setHasRecentNudge] = useState(false);
      const [currentRank, setCurrentRank] = useState(5);
      const [currentPage, setCurrentPage] = useState('dashboard');
      const [sessionData, setSessionData] = useState({
        tripDuration: 0,
        nudgeActivations: 0,
        forbiddenAppTime: 0
      });
      const [savedSessionData, setSavedSessionData] = useState({
        tripDurationSeconds: 0,
        nudgeActivations: 0,
        forbiddenAppTime: 0
      });
      const [leaderboardFilter, setLeaderboardFilter] = useState('all');
      const [tripHistory, setTripHistory] = useState([]);
      const [totalStats, setTotalStats] = useState({
        totalTrips: 0,
        totalDuration: 0,
        bestScore: 0,
        totalCoins: 0
      });
      const [friends, setFriends] = useState([
        { id: 1, name: 'Alex M.', avatar: '😎', score: 98, rank: 1 },
        { id: 2, name: 'Sarah K.', avatar: '🌟', score: 96, rank: 2 },
        { id: 3, name: 'Mike T.', avatar: '🚀', score: 95, rank: 3 },
        { id: 4, name: 'Emma L.', avatar: '💫', score: 89, rank: 6 },
        { id: 5, name: 'Jake R.', avatar: '🎮', score: 85, rank: 8 }
      ]);
      const [challenges, setChallenges] = useState([
        { id: 1, from: 'Alex M.', avatar: '😎', targetScore: 95, status: 'pending' }
      ]);
      const [allUsers, setAllUsers] = useState([
        { rank: 1, name: 'Alex M.', score: 98, avatar: '😎', isFriend: true, streak: 7, change: 2 },
        { rank: 2, name: 'Sarah K.', score: 96, avatar: '🌟', isFriend: true, streak: 5, change: 0 },
        { rank: 3, name: 'Mike T.', score: 95, avatar: '🚀', isFriend: true, streak: 3, change: -1 },
        { rank: 4, name: 'Chris P.', score: 94, avatar: '🎯', isFriend: false, streak: 2, change: 1 },
        { rank: 5, name: 'You', score: 92, avatar: '👤', isUser: true, streak: 0, change: 0 },
        { rank: 6, name: 'Emma L.', score: 89, avatar: '💫', isFriend: true, streak: 1, change: -2 },
        { rank: 7, name: 'David K.', score: 87, avatar: '🔥', isFriend: false, streak: 0, change: 0 },
        { rank: 8, name: 'Jake R.', score: 85, avatar: '🎮', isFriend: true, streak: 0, change: 3 },
        { rank: 9, name: 'Lisa M.', score: 82, avatar: '✨', isFriend: false, streak: 0, change: -1 },
        { rank: 10, name: 'Tom H.', score: 80, avatar: '🌈', isFriend: false, streak: 0, change: 0 }
      ]);
      const [showShareToast, setShowShareToast] = useState(false);
      const [shareMessage, setShareMessage] = useState('');

      const pointsIdRef = useRef(0);
      const tripIdRef = useRef(0);

      // Live score counter while driving in safe mode
      useEffect(() => {
        let interval = null;
        if (isDriving) {
          interval = setInterval(() => {
            const points = 5;
            setScore(prev => {
              const newScore = Math.min(prev + points, 100);
              
              // Update rank based on score
              if (newScore >= 98) setCurrentRank(1);
              else if (newScore >= 96) setCurrentRank(2);
              else if (newScore >= 95) setCurrentRank(3);
              else if (newScore >= 90) setCurrentRank(4);
              else setCurrentRank(5);
              
              // Check for milestones and unlock badges
              if (newScore >= 95 && !unlockedBadges.includes('focus')) {
                setUnlockedBadges(prev => [...prev, 'focus']);
                playDingSound();
                // Only animate rank on badge unlock
                setAnimatingRanks([1]);
                setTimeout(() => setAnimatingRanks([]), 300);
              }
              
              return newScore;
            });
            
            // Award coins
            setCoins(prev => prev + 2);
            
            // Add floating point animation
            const id = pointsIdRef.current++;
            setFloatingPoints(prev => [...prev, { id, value: points }]);
            setTimeout(() => {
              setFloatingPoints(prev => prev.filter(p => p.id !== id));
            }, 1000);
            
            playDingSound();
          }, 3000); // Add points every 3 seconds
        } else {
          if (interval) clearInterval(interval);
        }
        return () => {
          if (interval) clearInterval(interval);
        };
      }, [isDriving, unlockedBadges]);

      // Streak counter - increases every minute of safe driving
      useEffect(() => {
        let interval = null;
        if (isDriving) {
          interval = setInterval(() => {
            setStreak(prev => prev + 1);
          }, 60000); // Every minute
        }
        return () => {
          if (interval) clearInterval(interval);
        };
      }, [isDriving]);

      // Trip duration timer
      useEffect(() => {
        let interval = null;
        if (isDriving && startTime) {
          interval = setInterval(() => {
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            setTripDurationSeconds(elapsed);
            const minutes = Math.floor(elapsed / 60);
            setSessionData(prev => ({
              ...prev,
              tripDuration: minutes
            }));
            
            // Update session progress based on selected trip duration
            const progress = Math.min((elapsed / (tripDuration * 60)) * 100, 100);
            setSessionProgress(progress);
          }, 1000);
        } else {
          if (interval) clearInterval(interval);
        }
        return () => {
          if (interval) clearInterval(interval);
        };
      }, [isDriving, startTime]);

      const triggerVibration = () => {
        // Use selected alert mode
        if (alertMode === 'sound') {
          // Voice alert - speak warning message
          speakAlert(getRandomAlertMessage());
        } else {
          // Vibration mode - play buzz sound
          playBuzzSound();
          // Try to trigger device vibration if supported
          if (navigator.vibrate) {
            navigator.vibrate([200, 100, 200, 100, 200]);
          }
        }

        // Trigger phone shake
        setPhoneShake(true);
        setTimeout(() => {
          setPhoneShake(false);
        }, 500);

        // Show alert
        setShowAlert(true);
        
        // Mark recent nudge for progress bar
        setHasRecentNudge(true);
        setTimeout(() => {
          setHasRecentNudge(false);
        }, 3000);
        
        // Deduct points with negative hit animation
        setScore(prev => Math.max(prev - 10, 0));
        
        // Update session data
        setSessionData(prev => ({
          ...prev,
          nudgeActivations: prev.nudgeActivations + 1
        }));

        // Hide alert after 3 seconds
        setTimeout(() => {
          setShowAlert(false);
        }, 3000);
      };

      const handlePhoneUse = () => {
        triggerVibration();
      };

      const handleScreenClick = () => {
        if (isDriving) {
          triggerVibration();
        }
      };

      const startDriving = () => {
        const now = Date.now();
        setStartTime(now);
        setIsDriving(true);
        setTripDurationSeconds(0);
        setStreak(0);
        setSessionProgress(0);
        // Reset session data when starting a new drive
        setSessionData({
          tripDuration: 0,
          nudgeActivations: 0,
          forbiddenAppTime: 0
        });
      };

      const stopDriving = () => {
        setIsDriving(false);
        // Save the current session data before stopping
        setSavedSessionData({
          tripDurationSeconds: tripDurationSeconds,
          nudgeActivations: sessionData.nudgeActivations,
          forbiddenAppTime: sessionData.forbiddenAppTime
        });
        
        // Calculate coins earned this trip
        const coinsEarned = Math.max(0, Math.floor(tripDurationSeconds / 3) * 2 - sessionData.nudgeActivations * 5);
        
        // Save trip to history
        const newTrip = {
          id: tripIdRef.current++,
          timestamp: Date.now(),
          duration: tripDurationSeconds,
          score: score,
          nudges: sessionData.nudgeActivations,
          coinsEarned: coinsEarned
        };
        
        setTripHistory(prev => [...prev, newTrip]);
        
        // Update total stats
        setTotalStats(prev => ({
          totalTrips: prev.totalTrips + 1,
          totalDuration: prev.totalDuration + tripDurationSeconds,
          bestScore: Math.max(prev.bestScore, score),
          totalCoins: prev.totalCoins + coinsEarned
        }));
        
        // Update user position in leaderboard based on score
        setAllUsers(prev => {
          const updated = prev.map(u => 
            u.isUser ? { ...u, score: score, avatar: getAvatarEmoji(selectedAvatar) } : u
          );
          return updated.sort((a, b) => b.score - a.score).map((u, i) => ({ ...u, rank: i + 1 }));
        });
      };
      
      const handleShare = (platform) => {
        const shareText = `🚗 I scored ${score} points on DriveSafe! I'm ranked #${currentRank}. Can you beat my score? #DriveSafe #SafeDriving`;
        const shareUrl = 'https://drivesafe.app'; // Placeholder URL
        
        if (platform === 'twitter') {
          window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(shareText)}&url=${encodeURIComponent(shareUrl)}`, '_blank');
        } else if (platform === 'facebook') {
          window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(shareUrl)}&quote=${encodeURIComponent(shareText)}`, '_blank');
        } else if (platform === 'instagram') {
          // Instagram doesn't have a direct share URL API, so we copy and open Instagram
          navigator.clipboard.writeText(`${shareText}\n${shareUrl}`);
          setShareMessage('Caption copied! Opening Instagram...');
          setShowShareToast(true);
          setTimeout(() => setShowShareToast(false), 3000);
          // Open Instagram (will open app on mobile or website on desktop)
          window.open('https://www.instagram.com/', '_blank');
        } else if (platform === 'copy') {
          navigator.clipboard.writeText(`${shareText}\n${shareUrl}`);
          setShareMessage('Link copied to clipboard!');
          setShowShareToast(true);
          setTimeout(() => setShowShareToast(false), 3000);
        }
        playDingSound();
      };
      
      const handleChallenge = (friend) => {
        const newChallenge = {
          id: Date.now(),
          to: friend.name,
          toAvatar: friend.avatar,
          targetScore: score,
          status: 'sent',
          from: 'You',
          avatar: getAvatarEmoji(selectedAvatar)
        };
        setChallenges(prev => [...prev, newChallenge]);
        setShareMessage(`Challenge sent to ${friend.name}!`);
        setShowShareToast(true);
        setTimeout(() => setShowShareToast(false), 3000);
        playDingSound();
      };
      
      const handleAcceptChallenge = (challengeId) => {
        setChallenges(prev => 
          prev.map(c => c.id === challengeId ? { ...c, status: 'active' } : c)
        );
        playDingSound();
      };
      
      const handlePurchaseSkin = (skinId, price) => {
        if (coins >= price && !ownedSkins.includes(skinId)) {
          setCoins(prev => prev - price);
          setOwnedSkins(prev => [...prev, skinId]);
          setSelectedAvatar(skinId);
        }
      };
      
      const handleSelectAvatar = (skinId) => {
        if (ownedSkins.includes(skinId)) {
          setSelectedAvatar(skinId);
        }
      };
      
      const getAvatarEmoji = (skinId) => {
        const avatars = {
          'default': '👤',
          'cool': '😎',
          'star': '⭐',
          'fire': '🔥',
          'crown': '👑',
          'trophy': '🏆',
          'rocket': '🚀',
          'gem': '💎'
        };
        return avatars[skinId] || avatars['default'];
      };

      const renderView = () => {
        switch (viewMode) {
          case 'control':
            return <ControlView />;
          case 'nudge':
            return <NudgeOnlyView 
              onStartDriving={startDriving} 
              isDriving={isDriving}
              onStopDriving={stopDriving}
            />;
          case 'full':
            return <FullGamificationView 
              onStartDriving={startDriving} 
              isDriving={isDriving}
              onStopDriving={stopDriving}
              score={score}
              floatingPoints={floatingPoints}
              streak={streak}
              unlockedBadges={unlockedBadges}
              animatingRanks={animatingRanks}
              sessionProgress={sessionProgress}
              hasRecentNudge={hasRecentNudge}
              tripDuration={tripDuration}
              setTripDuration={setTripDuration}
              coins={coins}
              ownedSkins={ownedSkins}
              selectedAvatar={selectedAvatar}
              onPurchaseSkin={handlePurchaseSkin}
              onSelectAvatar={handleSelectAvatar}
              getAvatarEmoji={getAvatarEmoji}
              currentRank={currentRank}
              currentPage={currentPage}
              onNavigate={setCurrentPage}
              tripHistory={tripHistory}
              totalStats={totalStats}
              friends={friends}
              challenges={challenges}
              onChallenge={handleChallenge}
              onAcceptChallenge={handleAcceptChallenge}
              onShare={handleShare}
              leaderboardFilter={leaderboardFilter}
              setLeaderboardFilter={setLeaderboardFilter}
              allUsers={allUsers}
              theme={theme}
              setTheme={setTheme}
            />;
          default:
            return <FullGamificationView 
              onStartDriving={startDriving} 
              isDriving={isDriving}
              onStopDriving={stopDriving}
              score={score}
              floatingPoints={floatingPoints}
              streak={streak}
              unlockedBadges={unlockedBadges}
              animatingRanks={animatingRanks}
              sessionProgress={sessionProgress}
              hasRecentNudge={hasRecentNudge}
              tripDuration={tripDuration}
              setTripDuration={setTripDuration}
              coins={coins}
              ownedSkins={ownedSkins}
              selectedAvatar={selectedAvatar}
              onPurchaseSkin={handlePurchaseSkin}
              onSelectAvatar={handleSelectAvatar}
              getAvatarEmoji={getAvatarEmoji}
              currentRank={currentRank}
              currentPage={currentPage}
              onNavigate={setCurrentPage}
              tripHistory={tripHistory}
              totalStats={totalStats}
              friends={friends}
              challenges={challenges}
              onChallenge={handleChallenge}
              onAcceptChallenge={handleAcceptChallenge}
              onShare={handleShare}
              leaderboardFilter={leaderboardFilter}
              setLeaderboardFilter={setLeaderboardFilter}
              allUsers={allUsers}
              theme={theme}
              setTheme={setTheme}
            />;
        }
      };

      return (
        <div className={`min-h-screen gradient-bg flex flex-col items-center py-8 px-4 ${theme === 'light' ? 'light-theme' : ''}`}>
          <ControlToggle viewMode={viewMode} setViewMode={setViewMode} alertMode={alertMode} setAlertMode={setAlertMode} />
          
          <div className="mt-8">
            <PhoneFrame 
              showAlert={phoneShake} 
              onScreenClick={handleScreenClick}
              isDriving={isDriving}
            >
              {renderView()}
            </PhoneFrame>
          </div>

          {showAlert && <AlertOverlay />}
          
          {/* Share/Challenge Toast */}
          {showShareToast && (
            <div className="fixed bottom-8 left-1/2 transform -translate-x-1/2 z-50 animate-slideUp">
              <div className="glass-effect rounded-xl px-6 py-3 border border-green-500/50 shadow-lg" style={{ boxShadow: '0 0 30px rgba(34, 197, 94, 0.3)' }}>
                <div className="flex items-center gap-2 text-green-400 font-bold">
                  <span>✓</span>
                  <span>{shareMessage}</span>
                </div>
              </div>
            </div>
          )}

          <div className="mt-6 w-full max-w-sm">
            <div className="glass-effect rounded-2xl p-5 text-slate-300 card-glow border border-slate-700/50">
              <h3 className="text-base font-extrabold mb-4 text-slate-100 uppercase tracking-wide flex items-center gap-2">
                <span className="w-2 h-2 bg-green-400 rounded-full animate-pulse"></span>
                Session Log
              </h3>
              <div className="space-y-3 text-sm">
                <div className="flex justify-between items-center glass-effect rounded-lg p-3 border border-slate-700/50">
                  <span className="text-slate-300 font-semibold">Trip Duration:</span>
                  <span className="font-extrabold text-lg text-green-400">
                    {isDriving 
                      ? `${String(Math.floor(tripDurationSeconds / 60)).padStart(2, '0')}:${String(tripDurationSeconds % 60).padStart(2, '0')}`
                      : savedSessionData.tripDurationSeconds > 0 
                        ? `${String(Math.floor(savedSessionData.tripDurationSeconds / 60)).padStart(2, '0')}:${String(savedSessionData.tripDurationSeconds % 60).padStart(2, '0')}`
                        : '00:00'
                    }
                  </span>
                </div>
                <div className="flex justify-between items-center glass-effect rounded-lg p-3 border border-slate-700/50">
                  <span className="text-slate-300 font-semibold">Nudge Activations:</span>
                  <span className="font-extrabold text-lg text-yellow-400">
                    {isDriving ? sessionData.nudgeActivations : savedSessionData.nudgeActivations}
                  </span>
                </div>
                <div className="flex justify-between items-center glass-effect rounded-lg p-3 border border-slate-700/50">
                  <span className="text-slate-300 font-semibold">Forbidden App Time:</span>
                  <span className="font-extrabold text-lg text-red-400">
                    {isDriving ? sessionData.forbiddenAppTime : savedSessionData.forbiddenAppTime}s
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
